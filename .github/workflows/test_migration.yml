name: Test Migrations

on:
  workflow_call:
    inputs:
      ENVIRONMENT:
        required: true
        type: string
      GCP_DB_ZONE:
        description: 'Zone where the DB is hosted'
        type: string
        required: true
      VM_BASTION_NAME:
        description: 'Name of the vm bastion host'
        required: true
        type: string
      DB_TUNNEL_PORT:
        description: 'Port number to connect to the db through the ssh tunnel'
        required: true
        type: string

    
    secrets:
      GCP_SA_KEY:
        description: 'GCP Service Account Key JSON'
        required: true
      GCP_PROJECT_ID:
        description: 'GCP Project ID'
        required: true
      DB_NAME:
        required: true
      DB_PASSWORD:
        required: true
      DB_USER:
        required: true
      DB_HOST:
        required: true
      
jobs:
  test-migrations:
    runs-on: ubuntu-latest
    environment: ${{ inputs.ENVIRONMENT }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
          
      - name: Create SSH tunnel to bastion
        run: |
          gcloud compute ssh ${{inputs.VM_BASTION_NAME}} \
            --zone=${{inputs.GCP_DB_ZONE}} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --tunnel-through-iap \
            --ssh-flag="-L ${{inputs.DB_TUNNEL_PORT}}:${{secrets.DB_HOST}}:5432 -N -f"
          sleep 2
      
      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Create temporary database
        env:
          PGPASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          # Create a unique temp database name
          TEMP_DB="migrations_test_$(date +%Y%m%d_%H%M%S)"
          echo "TEMP_DB=$TEMP_DB" >> $GITHUB_ENV

          # Create the temporary database
          psql -h localhost -p ${{inputs.DB_TUNNEL_PORT}} -U ${{ secrets.DB_USER }} -d postgres -c "CREATE DATABASE $TEMP_DB;"
          echo "Created temporary database: $TEMP_DB"
      
      - name: Create dump from production database
        env:
          PGPASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          echo "Creating dump from production database..."
          pg_dump -h localhost -p ${{inputs.DB_TUNNEL_PORT}} \
            -U ${{ secrets.DB_USER }} \
            -d ${{ secrets.DB_NAME }} \
            -F c \
            -f production_dump.backup \
            --no-owner \
            --no-acl
          
          # Check dump size
          du -h production_dump.backup
          echo "Dump created successfully"
      
      - name: Restore dump to temporary database
        env:
          PGPASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          echo "Restoring dump to temporary database..."
          pg_restore -h localhost -p ${{inputs.DB_TUNNEL_PORT}} \
            -U ${{ secrets.DB_USER }} \
            -d $TEMP_DB \
            --no-owner \
            --no-acl \
            -v \
            production_dump.backup
          
          echo "Restore completed"
      
      - name: Verify database restore
        env:
          PGPASSWORD: ${{ secrets.DB_PASSWORD }}
          PGUSER: ${{ secrets.DB_USER }}
        run: |
          echo "Verifying restored database..."
          
          # Count tables
          TABLE_COUNT=$(psql -h localhost -p ${{inputs.DB_TUNNEL_PORT}} -U ${{ secrets.DB_USER }} -d $TEMP_DB -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';")
          echo "Tables found: $TABLE_COUNT"
          
          # List tables
          echo "Tables in database:"
          psql -h localhost -p ${{inputs.DB_TUNNEL_PORT}} -U ${{ secrets.DB_USER }} -d $TEMP_DB -c "\dt"
          
          if [ "$TABLE_COUNT" -lt 1 ]; then
            echo "No tables found in restored database"
            exit 1
          fi
          
          echo "Database verification passed"
      
      - name: Set up migration environment
        run: |
          pnpm --version
          echo "Dependencies installed"
      
      # - name: Run migrations on temporary database
      #   env:
      #     PGPASSWORD: ${{ secrets.DB_PASSWORD }}
      #     DATABASE_URL: postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASSWORD }}@localhost:${{inputs.DB_TUNNEL_PORT}}/${{ env.TEMP_DB }}
      #   run: |
      #     echo "Running migrations..."
      #     # pnpm run db:migrate
      #     pnpm --version
      #     echo "Migrations completed successfully"
      
      # - name: Verify migrations
      #   env:
      #     PGPASSWORD: ${{ secrets.DB_PASSWORD }}
      #   run: |
      #     echo "üîç Verifying migrations..."
          
      #     # Check migration status
      #     # Example for Prisma:
      #     # npx prisma migrate status
          
      #     # Example for Alembic:
      #     # alembic current
          
      #     # Custom verification queries
      #     psql -h localhost -p ${{inputs.DB_TUNNEL_PORT}} -U ${{ secrets.DB_USER }} -d $TEMP_DB -c "
      #       SELECT 
      #         schemaname,
      #         tablename 
      #       FROM pg_tables 
      #       WHERE schemaname = 'public' 
      #       ORDER BY tablename;
      #     "
          
      #     echo "Migration verification passed"
      
          
      - name: Cleanup - Drop temporary database
        if: always()
        env:
          PGPASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          if [ -n "$TEMP_DB" ]; then
            echo "Cleaning up temporary database: $TEMP_DB"
            
            # Terminate connections to the database
            psql -h localhost -p ${{inputs.DB_TUNNEL_PORT}} -U ${{ secrets.DB_USER }} -d postgres -c "
              SELECT pg_terminate_backend(pg_stat_activity.pid)
              FROM pg_stat_activity
              WHERE pg_stat_activity.datname = '$TEMP_DB'
                AND pid <> pg_backend_pid();
            "
            
            # Drop the database
            psql -h localhost -p ${{inputs.DB_TUNNEL_PORT}} -U ${{ secrets.DB_USER }} -d postgres -c "DROP DATABASE IF EXISTS $TEMP_DB;"
            echo "Temporary database dropped"
          fi
      
      # - name: Cleanup - Stop tunnels
      #   if: always()
      #   run: |
      #     echo "üßπ Stopping SSH tunnels..."
      #     pkill -f "ssh.*YOUR_BASTION_VM" || true
          
      #     gcloud compute ssh YOUR_BASTION_VM \
      #       --zone=YOUR_ZONE \
      #       --project=vxt-config-dev \
      #       --ssh-key-file=~/.ssh/bastion_key \
      #       --command="pkill -f cloud-sql-proxy || true" || true
          
      #     echo "‚úÖ Cleanup completed"
      
